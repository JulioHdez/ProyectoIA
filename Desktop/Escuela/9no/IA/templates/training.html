<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrenamiento Personalizado - Smart Shopping Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <style>
        .training-container {
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 2rem 0;
        }
        .training-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            padding: 2rem;
            margin-bottom: 2rem;
            color: var(--text-primary);
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-active {
            background: var(--success);
            animation: pulse 2s infinite;
        }
        .status-inactive {
            background: var(--text-muted);
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .product-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--info);
            color: var(--text-primary);
        }
        .product-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-hover);
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        /* Estilos para el modal de galería */
        .carousel-item img {
            max-height: 500px;
            object-fit: contain;
            margin: 0 auto;
            display: block;
        }
        
        .carousel-control-prev,
        .carousel-control-next {
            background-color: rgba(0, 0, 0, 0.7);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .carousel-control-prev {
            left: 20px;
        }
        
        .carousel-control-next {
            right: 20px;
        }
        
        .product-image-link {
            cursor: pointer;
            color: var(--info, #60a5fa);
            text-decoration: none;
        }
        
        .product-image-link:hover {
            color: var(--info, #60a5fa);
            text-decoration: underline;
            opacity: 0.8;
        }
        .progress-container {
            margin-top: 1rem;
        }
        .training-progress {
            height: 25px;
            border-radius: 12px;
            background-color: var(--bg-tertiary, #252525);
        }
        .training-progress .progress-bar {
            background-color: var(--success, #4ade80);
        }
        
        /* Los estilos de formularios y botones ya están en style.css */
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-shopping-cart me-2"></i>Smart Cart
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">
                            <i class="fas fa-home me-1"></i>Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('products') }}">
                            <i class="fas fa-box me-1"></i>Productos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('inventory') }}">
                            <i class="fas fa-warehouse me-1"></i>Inventario
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('camera') }}">
                            <i class="fas fa-camera me-1"></i>Cámara IA
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('training') }}">
                            <i class="fas fa-brain me-1"></i>Entrenamiento
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('sales') }}">
                            <i class="fas fa-chart-line me-1"></i>Ventas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('reports') }}">
                            <i class="fas fa-file-alt me-1"></i>Reportes
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="training-container">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="text-center mb-4">
                        <h1 class="display-4 mb-3">
                            <i class="fas fa-brain text-primary me-3"></i>
                            Entrenamiento Personalizado
                        </h1>
                        <p class="lead text-muted">
                            Entrena el modelo de IA para reconocer tus productos específicos
                        </p>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Estado del Entrenamiento -->
                <div class="col-lg-6">
                    <div class="training-card">
                        <h3 class="mb-3">
                            <i class="fas fa-info-circle me-2"></i>Estado del Sistema
                        </h3>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="d-flex align-items-center">
                                    <span class="status-indicator" id="trainingStatus"></span>
                                    <span id="trainingStatusText">Verificando...</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-end">
                                    <span class="badge bg-primary" id="productsCount">0</span>
                                    <small class="text-muted">Productos</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">TensorFlow:</small>
                                    <span class="badge" id="tensorflowStatus">Verificando...</span>
                                </div>
                            </div>
                        </div>

                        <div class="progress-container" id="progressContainer" style="display: none;">
                            <div class="progress training-progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" id="trainingProgress">
                                    <span id="progressText">0%</span>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>Productos Personalizados:</h5>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="sortByName">
                                        <i class="fas fa-sort-alpha-down me-1"></i>Nombre
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="sortByDate">
                                        <i class="fas fa-sort-numeric-down me-1"></i>Fecha
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="sortByImages">
                                        <i class="fas fa-images me-1"></i>Imágenes
                                    </button>
                                </div>
                            </div>
                            <div id="customProductsList">
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-box-open fa-2x mb-2"></i>
                                    <p>No hay productos personalizados</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Captura de Productos -->
                <div class="col-lg-6">
                    <div class="training-card">
                        <h3 class="mb-3">
                            <i class="fas fa-camera me-2"></i>Capturar Producto
                        </h3>
                        
                        <form id="captureForm">
                            <div class="mb-3">
                                <label for="productName" class="form-label">Nombre del Producto</label>
                                <input type="text" class="form-control" id="productName" 
                                       placeholder="Ej: Galletas Oreo" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="numImages" class="form-label">Número de Imágenes</label>
                                <select class="form-select" id="numImages">
                                    <option value="5">5 imágenes</option>
                                    <option value="10" selected>10 imágenes</option>
                                    <option value="15">15 imágenes</option>
                                    <option value="20">20 imágenes</option>
                                </select>
                            </div>
                            
                            <button type="button" class="btn btn-primary w-100" id="startCaptureBtn">
                                <i class="fas fa-camera me-1"></i>Iniciar Captura
                            </button>
                        </form>

                        <!-- Interfaz de Captura -->
                        <div id="captureInterface" style="display: none;" class="mt-4">
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableYOLODetection" checked>
                                    <label class="form-check-label" for="enableYOLODetection">
                                        Detección YOLO en tiempo real (mostrar silueta)
                                    </label>
                                </div>
                            </div>
                            <div class="video-container mb-3 position-relative">
                                <video id="captureVideo" width="640" height="480" autoplay muted playsinline style="display: block; width: 100%; height: auto; border: 1px solid var(--border-color); border-radius: var(--radius-md);"></video>
                                <canvas id="captureCanvas" width="640" height="480" style="display: none; width: 100%; height: auto; border: 1px solid var(--border-color); border-radius: var(--radius-md);"></canvas>
                                <canvas id="detectionCanvas" style="display: none;"></canvas>
                            </div>
                            
                            <div class="text-center mb-3">
                                <div class="alert alert-info">
                                    <strong>Capturas:</strong> <span id="captureCount">0</span> / <span id="totalCaptures">10</span>
                                    <span id="detectionStatus" class="ms-2"></span>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <button class="btn btn-success me-2" id="captureBtn">
                                    <i class="fas fa-camera me-1"></i>Capturar
                                </button>
                                <button class="btn btn-secondary" id="finishCaptureBtn">
                                    <i class="fas fa-check me-1"></i>Finalizar
                                </button>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h5>Instrucciones:</h5>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>Coloca el producto frente a la cámara</li>
                                <li><i class="fas fa-check text-success me-2"></i>Presiona "Capturar" para cada imagen</li>
                                <li><i class="fas fa-check text-success me-2"></i>Captura desde diferentes ángulos</li>
                                <li><i class="fas fa-check text-success me-2"></i>Presiona "Finalizar" cuando termines</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Entrenamiento -->
                    <div class="training-card">
                        <h3 class="mb-3">
                            <i class="fas fa-cogs me-2"></i>Entrenar Modelo
                        </h3>
                        
                        <form id="trainingForm">
                            <div class="mb-3">
                                <label for="trainingType" class="form-label">Tipo de Entrenamiento</label>
                                <select class="form-select" id="trainingType">
                                    <option value="yolo" selected>YOLO (Detección de objetos)</option>
                                    <option value="tensorflow">TensorFlow (Clasificación de imágenes)</option>
                                </select>
                                <small class="text-muted">
                                    <div class="mt-1">
                                        <strong>YOLO:</strong> Detecta objetos con bounding boxes<br>
                                        <strong>TensorFlow:</strong> Clasifica imágenes completas
                                    </div>
                                </small>
                            </div>
                            
                            <!-- Configuración YOLO -->
                            <div id="yoloConfig">
                                <div class="mb-3">
                                    <label for="epochs" class="form-label">Épocas de Entrenamiento</label>
                                    <select class="form-select" id="epochs">
                                        <option value="25">25 épocas (rápido)</option>
                                        <option value="50" selected>50 épocas (recomendado)</option>
                                        <option value="100">100 épocas (preciso)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="batchSize" class="form-label">Tamaño del Batch</label>
                                    <select class="form-select" id="batchSize">
                                        <option value="8">8 (memoria baja)</option>
                                        <option value="16" selected>16 (recomendado)</option>
                                        <option value="32">32 (memoria alta)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Configuración TensorFlow -->
                            <div id="tensorflowConfig" style="display: none;">
                                <div class="mb-3">
                                    <label for="tfEpochs" class="form-label">Épocas de Entrenamiento</label>
                                    <select class="form-select" id="tfEpochs">
                                        <option value="25">25 épocas (rápido)</option>
                                        <option value="50" selected>50 épocas (recomendado)</option>
                                        <option value="100">100 épocas (preciso)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="tfBatchSize" class="form-label">Tamaño del Batch</label>
                                    <select class="form-select" id="tfBatchSize">
                                        <option value="16">16 (memoria baja)</option>
                                        <option value="32" selected>32 (recomendado)</option>
                                        <option value="64">64 (memoria alta)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="tfModelType" class="form-label">Tipo de Modelo</label>
                                    <select class="form-select" id="tfModelType">
                                        <option value="mobilenet" selected>MobileNet (rápido y eficiente)</option>
                                        <option value="efficientnet">EfficientNet (balanceado)</option>
                                        <option value="resnet">ResNet (muy preciso)</option>
                                        <option value="custom">Personalizado</option>
                                    </select>
                                    <small class="text-muted">
                                        MobileNet es recomendado para empezar
                                    </small>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-success w-100" id="trainBtn" disabled>
                                <i class="fas fa-play me-1"></i>Iniciar Entrenamiento
                            </button>
                        </form>

                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                El entrenamiento puede tomar varios minutos dependiendo del número de productos.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="alertToast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <strong class="me-auto">Smart Cart</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="alertMessage" style="color: #000000 !important;">
                Mensaje de alerta
            </div>
        </div>
    </div>

    <!-- Modal para galería de imágenes -->
    <div class="modal fade" id="imageGalleryModal" tabindex="-1" aria-labelledby="imageGalleryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageGalleryModalLabel">Galería de Imágenes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="imageCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner" id="carouselInner">
                            <!-- Las imágenes se cargarán aquí dinámicamente -->
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#imageCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Anterior</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#imageCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Siguiente</span>
                        </button>
                    </div>
                    <div class="text-center mt-3">
                        <span id="imageCounter" class="badge bg-primary">1 / 1</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let isTraining = false;
        let isCapturing = false;
        let captureStream = null;
        let capturedImages = [];
        let currentProductName = '';
        let totalImages = 10;
        let currentSort = 'name'; // 'name', 'date', 'images'
        let yoloDetectionInterval = null;
        let yoloEnabled = true;

        function showAlert(message, type = 'info') {
            const alertToast = document.getElementById('alertToast');
            const alertMessage = document.getElementById('alertMessage');
            
            alertMessage.textContent = message;
            
            // Configurar colores según el tipo
            if (type === 'error') {
                alertToast.className = 'toast bg-danger';
                alertMessage.style.color = '#ffffff !important'; // Blanco para errores (fondo rojo)
            } else if (type === 'success') {
                alertToast.className = 'toast bg-success';
                alertMessage.style.color = '#000000 !important'; // Negro para éxito
            } else if (type === 'warning') {
                alertToast.className = 'toast bg-warning';
                alertMessage.style.color = '#000000 !important'; // Negro para advertencias
            } else {
                alertToast.className = 'toast bg-info';
                alertMessage.style.color = '#000000 !important'; // Negro para info
            }
            
            const toast = new bootstrap.Toast(alertToast);
            toast.show();
        }

        function updateTrainingStatus() {
            // Actualizar estado YOLO
            fetch('/get_training_status')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const status = data.data;
                    
                    // Actualizar estado del entrenamiento
                    const statusIndicator = document.getElementById('trainingStatus');
                    const statusText = document.getElementById('trainingStatusText');
                    const productsCount = document.getElementById('productsCount');
                    const trainBtn = document.getElementById('trainBtn');
                    
                    if (status.is_training) {
                        statusIndicator.className = 'status-indicator status-active';
                        statusText.textContent = 'Entrenando...';
                        trainBtn.disabled = true;
                        trainBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Entrenando...';
                    } else {
                        statusIndicator.className = 'status-indicator status-inactive';
                        statusText.textContent = 'Listo para entrenar';
                        trainBtn.disabled = status.custom_products_count === 0;
                        trainBtn.innerHTML = '<i class="fas fa-play me-1"></i>Iniciar Entrenamiento';
                    }
                    
                    productsCount.textContent = status.custom_products_count;
                    
                    // Actualizar lista de productos con información detallada
                    if (status.custom_products_count > 0) {
                        fetch('/get_custom_products')
                            .then(response => response.json())
                            .then(productsData => {
                                if (productsData.status === 'success') {
                                    renderProductsList(productsData.products);
                                } else {
                                    updateProductsList(status.products);
                                }
                            })
                            .catch(() => {
                                updateProductsList(status.products);
                            });
                    } else {
                        renderProductsList([]);
                    }
                }
            })
            .catch(error => {
                console.error('Error obteniendo estado:', error);
            });
            
            // Actualizar estado TensorFlow
            fetch('/get_tensorflow_status')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const tfStatus = data.data;
                    const tfStatusBadge = document.getElementById('tensorflowStatus');
                    
                    if (tfStatus.available) {
                        if (tfStatus.model_loaded) {
                            tfStatusBadge.className = 'badge bg-success';
                            tfStatusBadge.textContent = 'Disponible (Modelo cargado)';
                        } else {
                            tfStatusBadge.className = 'badge bg-info';
                            tfStatusBadge.textContent = 'Disponible';
                        }
                    } else {
                        tfStatusBadge.className = 'badge bg-secondary';
                        tfStatusBadge.textContent = 'No disponible';
                        tfStatusBadge.title = 'Instala TensorFlow: pip install tensorflow==2.13.0';
                    }
                }
            })
            .catch(error => {
                console.error('Error obteniendo estado TensorFlow:', error);
                const tfStatusBadge = document.getElementById('tensorflowStatus');
                tfStatusBadge.className = 'badge bg-secondary';
                tfStatusBadge.textContent = 'Error';
            });
        }

        function updateProductsList(products) {
            // Convertir lista simple a formato con información detallada
            const productsWithDetails = products.map(name => ({
                name: name,
                image_count: 0, // Se actualizará con información real si está disponible
                created_at: new Date().toISOString()
            }));
            
            renderProductsList(productsWithDetails);
        }

        function deleteProduct(productName) {
            if (confirm(`¿Estás seguro de que quieres eliminar el producto "${productName}"?`)) {
                fetch('/delete_custom_product', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ product_name: productName })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showAlert(data.message, 'success');
                        updateTrainingStatus();
                    } else {
                        showAlert(data.message, 'error');
                    }
                })
                .catch(error => {
                    showAlert('Error al eliminar producto: ' + error.message, 'error');
                });
            }
        }

        // Función para iniciar captura web
        async function startWebCapture() {
            const productName = document.getElementById('productName').value;
            const numImages = parseInt(document.getElementById('numImages').value);
            
            if (!productName.trim()) {
                showAlert('Por favor ingresa un nombre para el producto', 'error');
                return;
            }
            
            try {
                // Solicitar acceso a la cámara
                captureStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    } 
                });
                
                const video = document.getElementById('captureVideo');
                const canvas = document.getElementById('captureCanvas');
                
                // Configurar variables
                currentProductName = productName;
                totalImages = numImages;
                capturedImages = [];
                yoloEnabled = document.getElementById('enableYOLODetection').checked;
                
                // Mostrar interfaz de captura
                document.getElementById('captureInterface').style.display = 'block';
                document.getElementById('captureForm').style.display = 'none';
                document.getElementById('totalCaptures').textContent = totalImages;
                document.getElementById('captureCount').textContent = '0';
                
                // Asignar stream al video
                video.srcObject = captureStream;
                
                // Esperar a que el video esté listo
                video.addEventListener('loadedmetadata', () => {
                    console.log('Video metadata cargada:', video.videoWidth, 'x', video.videoHeight);
                    
                    // Configurar canvas con el tamaño del video
                    canvas.width = video.videoWidth || 640;
                    canvas.height = video.videoHeight || 480;
                    
                    // Iniciar detección YOLO o mostrar video directamente
                    if (yoloEnabled) {
                        // Mostrar video primero, luego iniciar YOLO
                        setTimeout(() => {
                            startYOLODetection();
                        }, 1000); // Dar tiempo para que el video se muestre
                    }
                    // Si YOLO está desactivado, el video se muestra directamente
                });
                
                // También verificar cuando el video puede reproducir
                video.addEventListener('canplay', () => {
                    console.log('Video listo para reproducir');
                    if (!yoloEnabled) {
                        // Si YOLO está desactivado, asegurar que el video se vea
                        video.style.display = 'block';
                        canvas.style.display = 'none';
                    }
                });
                
                // Forzar play del video
                video.play().catch(err => {
                    console.error('Error al reproducir video:', err);
                    showAlert('Error al iniciar la cámara: ' + err.message, 'error');
                });
                
                showAlert('Cámara iniciada. Coloca el producto frente a la cámara', 'success');
                
            } catch (error) {
                console.error('Error al acceder a la cámara:', error);
                showAlert('Error al acceder a la cámara: ' + error.message, 'error');
            }
        }
        
        // Función para iniciar detección YOLO en tiempo real
        function startYOLODetection() {
            const video = document.getElementById('captureVideo');
            const canvas = document.getElementById('captureCanvas');
            const ctx = canvas.getContext('2d');
            const detectionStatus = document.getElementById('detectionStatus');
            
            // Verificar que el video esté listo
            if (video.readyState < video.HAVE_METADATA) {
                console.log('Esperando a que el video esté listo...');
                setTimeout(startYOLODetection, 200);
                return;
            }
            
            // Limpiar intervalo anterior si existe
            if (yoloDetectionInterval) {
                clearInterval(yoloDetectionInterval);
            }
            if (window.videoDrawInterval) {
                clearInterval(window.videoDrawInterval);
            }
            
            // Cambiar a canvas para mostrar detección YOLO
            video.style.display = 'none';
            canvas.style.display = 'block';
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            
            // Función para dibujar frame del video en el canvas
            function drawVideoFrame() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    try {
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    } catch (e) {
                        console.error('Error dibujando video:', e);
                    }
                }
            }
            
            // Dibujar video continuamente en el canvas (fallback)
            window.videoDrawInterval = setInterval(() => {
                if (video.readyState === video.HAVE_ENOUGH_DATA && !yoloEnabled) {
                    drawVideoFrame();
                }
            }, 33); // ~30 FPS
            
            // Detectar cada 500ms (2 FPS para no sobrecargar)
            yoloDetectionInterval = setInterval(async () => {
                if (video.readyState === video.HAVE_ENOUGH_DATA && yoloEnabled) {
                    try {
                        // Primero dibujar el video actual en el canvas
                        drawVideoFrame();
                        
                        // Capturar frame del video para enviar al servidor
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = video.videoWidth;
                        tempCanvas.height = video.videoHeight;
                        const tempCtx = tempCanvas.getContext('2d');
                        tempCtx.drawImage(video, 0, 0);
                        
                        // Convertir a base64
                        const imageData = tempCanvas.toDataURL('image/jpeg', 0.8);
                        
                        // Enviar al servidor para detección (sin await para no bloquear)
                        fetch('/detect_frame_yolo', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                image: imageData
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success' && data.image) {
                                // Cargar imagen procesada con silueta
                                const img = new Image();
                                img.onload = () => {
                                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                };
                                img.onerror = () => {
                                    // Si falla, mantener el video
                                    drawVideoFrame();
                                };
                                img.src = data.image;
                                
                                // Actualizar estado de detección
                                if (data.count > 0) {
                                    detectionStatus.innerHTML = `<span class="badge bg-success">Objeto detectado</span>`;
                                } else {
                                    detectionStatus.innerHTML = `<span class="badge bg-warning">Buscando objeto...</span>`;
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error en detección YOLO:', error);
                            // Si falla, mantener el video dibujado
                            drawVideoFrame();
                        });
                    } catch (error) {
                        console.error('Error procesando frame:', error);
                        drawVideoFrame();
                    }
                }
            }, 500); // Cada 500ms
        }
        
        // Toggle de detección YOLO
        document.addEventListener('DOMContentLoaded', function() {
            const yoloToggle = document.getElementById('enableYOLODetection');
            if (yoloToggle) {
                yoloToggle.addEventListener('change', function() {
                    yoloEnabled = this.checked;
                    const video = document.getElementById('captureVideo');
                    const canvas = document.getElementById('captureCanvas');
                    
                    if (captureStream) {
                        if (yoloEnabled) {
                            // Activar YOLO
                            startYOLODetection();
                        } else {
                            // Desactivar YOLO - mostrar video directamente
                            if (yoloDetectionInterval) {
                                clearInterval(yoloDetectionInterval);
                                yoloDetectionInterval = null;
                            }
                            if (window.videoDrawInterval) {
                                clearInterval(window.videoDrawInterval);
                                window.videoDrawInterval = null;
                            }
                            
                            // Mostrar video, ocultar canvas
                            video.style.display = 'block';
                            canvas.style.display = 'none';
                        }
                    }
                });
            }
        });
        
        // Función para capturar imagen
        function captureImage() {
            if (capturedImages.length >= totalImages) {
                showAlert('Ya has capturado el número máximo de imágenes', 'warning');
                return;
            }
            
            const video = document.getElementById('captureVideo');
            const canvas = document.getElementById('captureCanvas');
            
            // Crear un canvas temporal para capturar
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth || 640;
            tempCanvas.height = video.videoHeight || 480;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Si YOLO está activado y el canvas está visible, usar el canvas
            // Si no, usar el video directamente
            if (yoloEnabled && canvas.style.display !== 'none') {
                tempCtx.drawImage(canvas, 0, 0);
            } else {
                tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
            }
            
            // Convertir a base64
            const imageData = tempCanvas.toDataURL('image/jpeg', 0.8);
            capturedImages.push(imageData);
            
            // Actualizar contador
            document.getElementById('captureCount').textContent = capturedImages.length;
            
            showAlert(`Imagen ${capturedImages.length} capturada`, 'success');
            
            // Si se alcanzó el máximo, finalizar automáticamente
            if (capturedImages.length >= totalImages) {
                finishCapture();
            }
        }
        
        // Función para finalizar captura
        async function finishCapture() {
            if (capturedImages.length === 0) {
                showAlert('No se capturaron imágenes', 'error');
                return;
            }
            
            try {
                // Detener cámara
                if (captureStream) {
                    captureStream.getTracks().forEach(track => track.stop());
                }
                
                // Enviar imágenes al servidor
                const response = await fetch('/capture_images_from_web', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        product_name: currentProductName,
                        images: capturedImages,
                        num_images: capturedImages.length
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert(`Producto "${currentProductName}" agregado con ${capturedImages.length} imágenes`, 'success');
                    document.getElementById('productName').value = '';
                    updateTrainingStatus();
                } else {
                    showAlert(data.message, 'error');
                }
                
            } catch (error) {
                showAlert('Error al procesar imágenes: ' + error.message, 'error');
            } finally {
                // Limpiar interfaz
                cleanupCamera();
                capturedImages = [];
                currentProductName = '';
            }
        }

        // Función para cerrar la cámara automáticamente
        function cleanupCamera() {
            // Detener detección YOLO
            if (yoloDetectionInterval) {
                clearInterval(yoloDetectionInterval);
                yoloDetectionInterval = null;
            }
            
            // Detener dibujo de video
            if (window.videoDrawInterval) {
                clearInterval(window.videoDrawInterval);
                window.videoDrawInterval = null;
            }
            
            if (captureStream) {
                captureStream.getTracks().forEach(track => track.stop());
                captureStream = null;
            }
            
            const video = document.getElementById('captureVideo');
            if (video && video.srcObject) {
                video.srcObject = null;
            }
            
            const captureInterface = document.getElementById('captureInterface');
            const captureForm = document.getElementById('captureForm');
            if (captureInterface) {
                captureInterface.style.display = 'none';
            }
            if (captureForm) {
                captureForm.style.display = 'block';
            }
            
            // Limpiar canvas
            const canvas = document.getElementById('captureCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Cerrar cámara al salir de la página
        window.addEventListener('beforeunload', function() {
            cleanupCamera();
        });

        // Cerrar cámara cuando la página pierde el foco
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && captureStream) {
                cleanupCamera();
            }
        });

        // Cerrar cámara cuando se hace clic en un enlace de navegación
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a');
            if (link && link.href && !link.href.includes('#') && captureStream) {
                cleanupCamera();
            }
        });
        
        // Funciones de ordenamiento
        function sortProducts(sortBy) {
            currentSort = sortBy;
            updateTrainingStatus();
            
            // Actualizar botones activos
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`sortBy${sortBy.charAt(0).toUpperCase() + sortBy.slice(1)}`).classList.add('active');
        }
        
        function renderProductsList(products) {
            const container = document.getElementById('customProductsList');
            
            if (!products || products.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-box-open fa-2x mb-2"></i>
                        <p>No hay productos personalizados</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar productos según el criterio actual
            let sortedProducts = [...products];
            switch(currentSort) {
                case 'name':
                    sortedProducts.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'date':
                    sortedProducts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
                case 'images':
                    sortedProducts.sort((a, b) => b.image_count - a.image_count);
                    break;
            }
            
            container.innerHTML = sortedProducts.map(product => `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${product.name}</h6>
                        <small class="text-muted">
                            <i class="fas fa-images me-1"></i>
                            <span class="product-image-link" onclick="showImageGallery('${product.name}', ${product.image_count})">
                                ${product.image_count} imágenes
                            </span>
                            <span class="mx-2">•</span>
                            <i class="fas fa-calendar me-1"></i>${new Date(product.created_at).toLocaleDateString()}
                        </small>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteProduct('${product.name}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }
        
        // Event listeners
        document.getElementById('startCaptureBtn').addEventListener('click', startWebCapture);
        document.getElementById('captureBtn').addEventListener('click', captureImage);
        document.getElementById('finishCaptureBtn').addEventListener('click', finishCapture);
        
        // Event listeners para ordenamiento
        document.getElementById('sortByName').addEventListener('click', () => sortProducts('name'));
        document.getElementById('sortByDate').addEventListener('click', () => sortProducts('date'));
        document.getElementById('sortByImages').addEventListener('click', () => sortProducts('images'));
        
        // Función para mostrar la galería de imágenes
        function showImageGallery(productName, imageCount) {
            if (imageCount === 0) {
                showAlert('No hay imágenes disponibles para este producto', 'warning');
                return;
            }
            
            // Actualizar el título del modal
            document.getElementById('imageGalleryModalLabel').textContent = `Galería de Imágenes - ${productName}`;
            
            // Cargar las imágenes del producto
            loadProductImages(productName);
        }
        
        // Función para cargar las imágenes del producto
        async function loadProductImages(productName) {
            try {
                const response = await fetch(`/get_product_images/${encodeURIComponent(productName)}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayImagesInModal(data.images, productName);
                } else {
                    showAlert('Error al cargar las imágenes: ' + data.message, 'error');
                }
            } catch (error) {
                showAlert('Error al cargar las imágenes: ' + error.message, 'error');
            }
        }
        
        // Función para mostrar las imágenes en el modal
        function displayImagesInModal(images, productName) {
            const carouselInner = document.getElementById('carouselInner');
            const imageCounter = document.getElementById('imageCounter');
            
            // Limpiar el carousel
            carouselInner.innerHTML = '';
            
            if (images.length === 0) {
                carouselInner.innerHTML = `
                    <div class="carousel-item active">
                        <div class="text-center py-5">
                            <i class="fas fa-image fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No hay imágenes disponibles</p>
                        </div>
                    </div>
                `;
                imageCounter.textContent = '0 / 0';
                return;
            }
            
            // Crear los elementos del carousel
            images.forEach((imagePath, index) => {
                const carouselItem = document.createElement('div');
                carouselItem.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                carouselItem.innerHTML = `
                    <img src="/static/custom_products/${productName}/${imagePath}" 
                         class="d-block w-100" 
                         alt="Imagen ${index + 1} de ${productName}"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkVycm9yIGFsIGNhcmdhciBpbWFnZW48L3RleHQ+PC9zdmc+'">
                `;
                carouselInner.appendChild(carouselItem);
            });
            
            // Actualizar contador
            imageCounter.textContent = `1 / ${images.length}`;
            
            // Configurar eventos del carousel para actualizar el contador
            const carousel = document.getElementById('imageCarousel');
            carousel.addEventListener('slide.bs.carousel', function (event) {
                const activeIndex = event.to;
                imageCounter.textContent = `${activeIndex + 1} / ${images.length}`;
            });
            
            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('imageGalleryModal'));
            modal.show();
        }

        // Cambiar configuración según tipo de entrenamiento
        document.getElementById('trainingType').addEventListener('change', function() {
            const trainingType = this.value;
            const yoloConfig = document.getElementById('yoloConfig');
            const tensorflowConfig = document.getElementById('tensorflowConfig');
            
            if (trainingType === 'yolo') {
                yoloConfig.style.display = 'block';
                tensorflowConfig.style.display = 'none';
            } else {
                yoloConfig.style.display = 'none';
                tensorflowConfig.style.display = 'block';
            }
        });

        // Formulario de entrenamiento
        document.getElementById('trainingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (isTraining) {
                showAlert('Ya hay un entrenamiento en progreso', 'error');
                return;
            }
            
            const trainingType = document.getElementById('trainingType').value;
            
            isTraining = true;
            const trainBtn = document.getElementById('trainBtn');
            trainBtn.disabled = true;
            trainBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Entrenando...';
            
            // Mostrar barra de progreso
            document.getElementById('progressContainer').style.display = 'block';
            
            let endpoint, requestBody;
            
            if (trainingType === 'yolo') {
                // Entrenamiento YOLO
                const epochs = parseInt(document.getElementById('epochs').value);
                const batchSize = parseInt(document.getElementById('batchSize').value);
                
                endpoint = '/start_training';
                requestBody = {
                    epochs: epochs,
                    batch_size: batchSize
                };
            } else {
                // Entrenamiento TensorFlow
                const epochs = parseInt(document.getElementById('tfEpochs').value);
                const batchSize = parseInt(document.getElementById('tfBatchSize').value);
                const modelType = document.getElementById('tfModelType').value;
                
                endpoint = '/start_tensorflow_training';
                requestBody = {
                    epochs: epochs,
                    batch_size: batchSize,
                    model_type: modelType
                };
            }
            
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showAlert(data.message, 'success');
                    
                    // Simular progreso (en una implementación real, esto vendría del servidor)
                    simulateTrainingProgress();
                } else {
                    showAlert(data.message, 'error');
                    isTraining = false;
                    trainBtn.disabled = false;
                    trainBtn.innerHTML = '<i class="fas fa-play me-1"></i>Iniciar Entrenamiento';
                    document.getElementById('progressContainer').style.display = 'none';
                }
            })
            .catch(error => {
                showAlert('Error al iniciar entrenamiento: ' + error.message, 'error');
                isTraining = false;
                trainBtn.disabled = false;
                trainBtn.innerHTML = '<i class="fas fa-play me-1"></i>Iniciar Entrenamiento';
                document.getElementById('progressContainer').style.display = 'none';
            });
        });

        function simulateTrainingProgress() {
            let progress = 0;
            const progressBar = document.getElementById('trainingProgress');
            const progressText = document.getElementById('progressText');
            
            const interval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 100) progress = 100;
                
                progressBar.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        isTraining = false;
                        updateTrainingStatus();
                        document.getElementById('progressContainer').style.display = 'none';
                        showAlert('Entrenamiento completado exitosamente', 'success');
                    }, 1000);
                }
            }, 1000);
        }

        // Actualizar estado cada 5 segundos
        setInterval(updateTrainingStatus, 5000);

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            updateTrainingStatus();
        });
    </script>
</body>
</html>
